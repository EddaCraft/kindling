# Steps: CLI-004

| Field | Value |
|-------|-------|
| Source | [../modules/kindling-cli.aps.md](../modules/kindling-cli.aps.md) |
| Task(s) | CLI-004 — Implement export/import commands |
| Created by | @aneki / AI |
| Status | Draft |

## Why This Matters

Users need to backup, migrate, and share their local memory. Export/import via CLI enables these workflows without adapter integration. This is critical for data portability and disaster recovery.

## What We're Building

Export/import commands that:
- Export memory to portable files
- Import from export files
- Support scope filtering
- Handle conflicts safely

## Prerequisites

- [ ] CLI-001 complete (CLI scaffold exists)
- [ ] STORAGE-005 complete (store-level export/import)
- [ ] KINDLING-005 complete (export coordination)

## Steps

### 1. Implement export command

- **Why:** Users need to backup their memory
- **What:** Export command producing portable file
- **Checkpoint:** `src/cli/commands/export.ts`:
  - Accepts --output flag (default: kindling-export-{timestamp}.ndjson)
  - Accepts --scope flag (session, repo filter)
  - Accepts --from and --to flags (time range)
  - Calls export coordination
  - Shows progress for large exports
- **Validate:** `pnpm tsc --noEmit`

### 2. Implement export output

- **Why:** Users need feedback on export
- **What:** Export completion summary
- **Checkpoint:** Export command output:
  - Shows output file path
  - Shows entity counts (observations, capsules, etc.)
  - Shows file size
  - Shows time taken
- **Validate:** Manual verification

### 3. Implement import command

- **Why:** Users need to restore from backups
- **What:** Import command reading export files
- **Checkpoint:** `src/cli/commands/import.ts`:
  - Accepts input file path
  - Accepts --conflict flag (skip, overwrite, error)
  - Validates file before import
  - Shows progress for large imports
- **Validate:** `pnpm tsc --noEmit`

### 4. Implement import validation

- **Why:** Invalid files should fail early
- **What:** Pre-import validation
- **Checkpoint:** Import command validates:
  - File exists and is readable
  - File format is valid NDJSON
  - Bundle version is compatible
  - Shows validation errors clearly
- **Validate:** `pnpm tsc --noEmit`

### 5. Implement conflict handling UI

- **Why:** Users need to understand conflict resolution
- **What:** Clear conflict feedback
- **Checkpoint:** Import output shows:
  - Count of imported entities
  - Count of skipped (if --conflict=skip)
  - Count of overwritten (if --conflict=overwrite)
  - First error (if --conflict=error)
- **Validate:** Manual verification

### 6. Implement dry-run mode

- **Why:** Users want to preview before committing
- **What:** Dry-run flag for import
- **Checkpoint:** `src/cli/commands/import.ts` supports --dry-run:
  - Validates file
  - Counts entities
  - Detects conflicts
  - Does not modify database
  - Shows what would happen
- **Validate:** `pnpm tsc --noEmit`

### 7. Add progress indication

- **Why:** Large exports/imports need feedback
- **What:** Progress output during operations
- **Checkpoint:** Progress indication:
  - Shows entity count as processing
  - Shows percentage if total known
  - Updates in place (terminal escape)
  - Disabled in --json mode
- **Validate:** Manual verification

### 8. Add export tests

- **Why:** Export must produce valid files
- **What:** Tests for export command
- **Checkpoint:** `test/cli.export.spec.ts` covers:
  - Export produces valid NDJSON
  - Scope filtering works
  - Time range filtering works
  - Output path respected
  - Empty export handled
- **Validate:** `pnpm test -- cli.export`

### 9. Add import tests

- **Why:** Import must be safe and correct
- **What:** Tests for import command
- **Checkpoint:** `test/cli.import.spec.ts` covers:
  - Import restores entities
  - Conflict strategies work
  - Invalid file rejected
  - Dry-run doesn't modify DB
  - Progress shown for large files
- **Validate:** `pnpm test -- cli.import`

### 10. Add round-trip tests

- **Why:** Export → import must preserve data
- **What:** End-to-end tests
- **Checkpoint:** `test/cli.roundtrip.spec.ts`:
  - Export → import to new DB
  - All entities preserved
  - Search works on imported data
- **Validate:** `pnpm test -- cli.roundtrip`

## Completion

- [ ] All checkpoints validated
- [ ] Task marked complete in source module

**Completed by:** ___
