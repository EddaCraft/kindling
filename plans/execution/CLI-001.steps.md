# Steps: CLI-001

| Field | Value |
|-------|-------|
| Source | [../modules/kindling-cli.aps.md](../modules/kindling-cli.aps.md) |
| Task(s) | CLI-001 — Implement core CLI scaffold and status command |
| Created by | @aneki / AI |
| Status | Draft |

## Why This Matters

The CLI provides direct access to Kindling without requiring an adapter. Users need to inspect, debug, and manage their local memory independently. The status command is the foundation—it confirms the system is working and shows basic diagnostics.

## What We're Building

A CLI scaffold that:
- Parses commands and arguments
- Routes to appropriate handlers
- Provides a status command for diagnostics
- Supports human-readable and JSON output

## Prerequisites

- [ ] Package structure exists (`packages/kindling-cli/`)
- [ ] STORAGE-001 complete (database accessible)

## Steps

### 1. Choose argument parsing library

- **Why:** Consistent argument parsing improves UX
- **What:** Library selection and setup
- **Checkpoint:** Decision documented:
  - Library selected (e.g., commander, yargs, citty)
  - Rationale recorded
  - Package added to dependencies
- **Validate:** `pnpm install` succeeds

### 2. Create CLI entry point

- **Why:** Single entry point for all commands
- **What:** Main CLI file with routing
- **Checkpoint:** `src/cli/index.ts`:
  - Parses top-level arguments
  - Routes to subcommands
  - Handles `--help` and `--version`
  - Sets up `--json` flag for machine output
- **Validate:** `pnpm tsc --noEmit`

### 3. Define command interface

- **Why:** Consistent structure for all commands
- **What:** Types for command handlers
- **Checkpoint:** `src/cli/types.ts` exports:
  - `CommandContext` (db, options, output)
  - `CommandResult` (success, data, error?)
  - `CommandHandler` interface
- **Validate:** `pnpm tsc --noEmit`

### 4. Implement output formatter

- **Why:** Human and machine output from same data
- **What:** Formatter that respects --json flag
- **Checkpoint:** `src/cli/output.ts` exports:
  - `formatOutput(data, options)` — returns formatted string
  - Human format: tables, colors, readable text
  - JSON format: structured JSON
- **Validate:** `pnpm tsc --noEmit`

### 5. Implement status command

- **Why:** Users need to verify system state
- **What:** Status command showing diagnostics
- **Checkpoint:** `src/cli/commands/status.ts`:
  - Shows DB path
  - Shows observation count
  - Shows capsule count (open/closed)
  - Shows pin count
  - Shows DB file size
  - Shows last activity time
- **Validate:** `pnpm tsc --noEmit`

### 6. Implement DB connection handling

- **Why:** CLI needs to find and open the database
- **What:** DB discovery and connection
- **Checkpoint:** `src/cli/db.ts` exports `connectDb()`:
  - Checks default location (~/.kindling/kindling.db)
  - Respects --db flag override
  - Respects KINDLING_DB env var
  - Returns helpful error if DB not found
- **Validate:** `pnpm tsc --noEmit`

### 7. Add error handling

- **Why:** Errors must be user-friendly
- **What:** Global error handler
- **Checkpoint:** `src/cli/index.ts`:
  - Catches unhandled errors
  - Formats error message for humans
  - Exits with non-zero code on error
  - Includes stack trace in --verbose mode
- **Validate:** `pnpm tsc --noEmit`

### 8. Add CLI tests

- **Why:** CLI behaviour must be reliable
- **What:** Tests for CLI basics
- **Checkpoint:** `test/cli.spec.ts` covers:
  - --help shows usage
  - --version shows version
  - Unknown command shows error
  - status command works
  - --json flag produces valid JSON
- **Validate:** `pnpm test -- cli`

### 9. Add package binary entry

- **Why:** CLI must be invokable as `kindling`
- **What:** Package.json bin configuration
- **Checkpoint:** `package.json`:
  - bin field points to built CLI
  - Shebang in entry file
  - Executable after `pnpm build`
- **Validate:** `./bin/kindling --help` works

## Completion

- [ ] All checkpoints validated
- [ ] Task marked complete in source module

**Completed by:** ___
